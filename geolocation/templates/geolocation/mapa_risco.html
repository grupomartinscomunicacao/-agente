{% extends 'dashboard/base.html' %}

{% block title %}Mapa de Risco - Sistema de Saúde{% endblock %}

{% block page_title %}
    <span class="page-title">Mapa de Risco Geográfico</span>
{% endblock %}

{% block page_actions %}
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filtrosModal">
            <i class="fas fa-filter me-2"></i>Filtros
        </button>
        <a href="{% url 'geolocation:estatisticas_risco' %}" class="btn btn-outline-primary">
            <i class="fas fa-chart-bar me-2"></i>Estatísticas
        </a>
        <a href="{% url 'geolocation:lista_relatorios' %}" class="btn btn-outline-success">
            <i class="fas fa-file-medical me-2"></i>Relatórios
        </a>
    </div>
{% endblock %}

{% block extra_css %}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <style>
        #mapa-risco {
            height: 600px;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            z-index: 1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .risk-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .risk-legend h6 {
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .leaflet-popup-content {
            max-width: 250px;
        }
        
        .popup-header {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .popup-info {
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .risk-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
            margin-top: 5px;
        }
        
        .risk-baixo { background-color: #28a745; }
        .risk-medio { background-color: #ffc107; }
        .risk-alto { background-color: #dc3545; }
        .risk-critico { background-color: #a71d2a; }
    </style>
{% endblock %}

{% block content %}
    <!-- Estatísticas do Mapa -->
    <div class="stats-grid">
        <div class="stat-card text-center">
            <div class="icon mx-auto" style="background-color: var(--primary-color);">
                <i class="fas fa-map-marker-alt"></i>
            </div>
            <h5 class="mt-3">Total de Localizações</h5>
            <p class="display-4" id="total-localizacoes">{{ stats.total }}</p>
        </div>
        
        <div class="stat-card text-center">
            <div class="icon mx-auto icon-success">
                <i class="fas fa-check-circle"></i>
            </div>
            <h5 class="mt-3">Baixo Risco</h5>
            <p class="display-4 text-success" id="total-baixo-risco">{{ stats.baixo }}</p>
        </div>
        
        <div class="stat-card text-center">
            <div class="icon mx-auto icon-warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h5 class="mt-3">Médio/Alto Risco</h5>
            <p class="display-4 text-warning" id="total-medio-alto-risco">{{ stats.medio|add:stats.alto }}</p>
        </div>
        
        <div class="stat-card text-center">
            <div class="icon mx-auto icon-danger">
                <i class="fas fa-skull-crossbones"></i>
            </div>
            <h5 class="mt-3">Risco Crítico</h5>
            <p class="display-4 text-danger" id="total-critico-risco">{{ stats.critico }}</p>
        </div>
    </div>

    <!-- Container do Mapa -->
    <div class="chart-container position-relative">
        <h5 class="card-header-custom mb-3">
            <i class="fas fa-globe-americas me-2"></i>Distribuição Geográfica de Riscos de Saúde
        </h5>
        
        <!-- Controles do Mapa -->
        <div class="map-controls">
            <div class="btn-group-vertical" role="group">
                <button type="button" class="btn btn-sm btn-outline-secondary" 
                        onclick="toggleHeatmap()" title="Alternar mapa de calor">
                    <i class="fas fa-fire"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" 
                        onclick="centerMap()" title="Centralizar mapa">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" 
                        onclick="fullscreenMap()" title="Tela cheia">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>
        
        <!-- Mapa -->
        <div id="mapa-risco"></div>
        
        <!-- Legenda -->
        <div class="risk-legend">
            <h6><i class="fas fa-info-circle me-1"></i>Níveis de Risco</h6>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #28a745;"></div>
                <span>Baixo Risco</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ffc107;"></div>
                <span>Médio Risco</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #dc3545;"></div>
                <span>Alto Risco</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #dc3545;"></div>
                <span>Risco Crítico</span>
            </div>
        </div>
    </div>

    <!-- Status de Atualização -->
    <div class="row mt-3">
        <div class="col-12 text-center">
            <small class="text-muted" id="ultima-atualizacao">
                <i class="fas fa-sync-alt me-1"></i>
                Última atualização: <span id="timestamp">--:--</span>
            </small>
        </div>
    </div>
{% endblock %}

<!-- Modal de Filtros -->
<div class="modal fade" id="filtrosModal" tabindex="-1" aria-labelledby="filtrosModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filtrosModalLabel">
                    <i class="fas fa-filter me-2"></i>Filtros do Mapa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="filtros-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="filtro-risco" class="form-label">Nível de Risco</label>
                                <select class="form-select" id="filtro-risco" name="risco">
                                    <option value="todos">Todos os níveis</option>
                                    <option value="baixo">Baixo Risco</option>
                                    <option value="medio">Médio Risco</option>
                                    <option value="alto">Alto Risco</option>
                                    <option value="critico">Risco Crítico</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="filtro-cidade" class="form-label">Cidade</label>
                                <input type="text" class="form-control" id="filtro-cidade" name="cidade" placeholder="Nome da cidade">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="filtro-data-inicio" class="form-label">Data Início</label>
                                <input type="date" class="form-control" id="filtro-data-inicio" name="data_inicio">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="filtro-data-fim" class="form-label">Data Fim</label>
                                <input type="date" class="form-control" id="filtro-data-fim" name="data_fim">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="limparFiltros()">Limpar</button>
                <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">Aplicar Filtros</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Plugin de Heatmap para Leaflet -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Variáveis globais
        let mapa = null;
        let marcadores = [];
        let heatmapLayer = null;
        let showHeatmap = false;

        // Inicializar mapa
        function inicializarMapa() {
            const centro = [{{ centro_mapa.lat }}, {{ centro_mapa.lng }}];
            
            mapa = L.map('mapa-risco', {
                center: centro,
                zoom: {{ centro_mapa.zoom }},
                zoomControl: false
            });

            // Adicionar controle de zoom personalizado
            L.control.zoom({
                position: 'bottomright'
            }).addTo(mapa);

            // Camadas de mapa
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            });

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            });

            const baseMaps = {
                "Mapa": osmLayer,
                "Satélite": satelliteLayer
            };

            osmLayer.addTo(mapa);
            L.control.layers(baseMaps).addTo(mapa);

            // Carregar dados iniciais
            carregarDadosMapa();
        }

        // Carregar dados do mapa
        function carregarDadosMapa(filtros = {}) {
            const url = new URL("{% url 'geolocation:mapa_dados_api' %}", window.location.origin);
            
            // Adicionar filtros à URL
            Object.keys(filtros).forEach(key => {
                if (filtros[key] && filtros[key] !== 'todos') {
                    url.searchParams.append(key, filtros[key]);
                }
            });

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        atualizarMarcadores(data.marcadores);
                        atualizarTimestamp();
                    } else {
                        console.error('Erro ao carregar dados:', data.error);
                        mostrarToast('Erro ao carregar dados do mapa', 'error');
                    }
                })
                .catch(error => {
                    console.error('Erro na requisição:', error);
                    mostrarToast('Erro de conexão', 'error');
                });
        }

        // Atualizar marcadores no mapa
        function atualizarMarcadores(dados) {
            // Limpar marcadores existentes
            marcadores.forEach(marcador => mapa.removeLayer(marcador));
            marcadores = [];

            // Dados para heatmap
            const heatmapData = [];

            // Adicionar novos marcadores
            dados.forEach(item => {
                const marker = L.circleMarker([item.lat, item.lng], {
                    color: item.cor_marcador,
                    fillColor: item.cor_marcador,
                    fillOpacity: 0.7,
                    radius: getRaioByRisco(item.nivel_risco),
                    weight: 2
                });

                // Popup com informações
                const popupContent = `
                    <div class="popup-header">${item.nome}</div>
                    <div class="popup-info">
                        <strong>Idade:</strong> ${item.idade} anos<br>
                        <strong>Endereço:</strong> ${item.endereco}<br>
                        <strong>Data:</strong> ${item.data_coleta}
                        <div class="risk-badge risk-${item.nivel_risco}">
                            ${item.nivel_risco.toUpperCase()} RISCO
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.addTo(mapa);
                marcadores.push(marker);

                // Dados para heatmap (intensidade baseada no risco)
                const intensidade = getIntensidadeByRisco(item.nivel_risco);
                heatmapData.push([item.lat, item.lng, intensidade]);
            });

            // Atualizar/criar heatmap
            if (heatmapLayer) {
                mapa.removeLayer(heatmapLayer);
            }
            
            heatmapLayer = L.heatLayer(heatmapData, {
                radius: 25,
                blur: 15,
                maxZoom: 17,
                max: 1.0,
                gradient: {
                    0.0: 'green',
                    0.3: 'yellow', 
                    0.6: 'orange',
                    1.0: 'red'
                }
            });

            if (showHeatmap) {
                heatmapLayer.addTo(mapa);
            }

            console.log(`${dados.length} marcadores carregados`);
        }

        // Helpers para cálculos
        function getRaioByRisco(nivel) {
            const raios = {
                'baixo': 6,
                'medio': 8,
                'alto': 10,
                'critico': 14
            };
            return raios[nivel] || 6;
        }

        function getIntensidadeByRisco(nivel) {
            const intensidades = {
                'baixo': 0.2,
                'medio': 0.5,
                'alto': 0.8,
                'critico': 1.0
            };
            return intensidades[nivel] || 0.2;
        }

        // Controles do mapa
        window.toggleHeatmap = function() {
            showHeatmap = !showHeatmap;
            if (showHeatmap) {
                if (heatmapLayer) heatmapLayer.addTo(mapa);
            } else {
                if (heatmapLayer) mapa.removeLayer(heatmapLayer);
            }
        };

        window.centerMap = function() {
            const centro = [{{ centro_mapa.lat }}, {{ centro_mapa.lng }}];
            mapa.setView(centro, {{ centro_mapa.zoom }});
        };

        window.fullscreenMap = function() {
            const mapContainer = document.getElementById('mapa-risco');
            if (mapContainer.requestFullscreen) {
                mapContainer.requestFullscreen();
            }
        };

        // Filtros
        window.aplicarFiltros = function() {
            const form = document.getElementById('filtros-form');
            const formData = new FormData(form);
            const filtros = Object.fromEntries(formData.entries());
            
            carregarDadosMapa(filtros);
            bootstrap.Modal.getInstance(document.getElementById('filtrosModal')).hide();
        };

        window.limparFiltros = function() {
            document.getElementById('filtros-form').reset();
            carregarDadosMapa();
        };

        // Utilitários
        function atualizarTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').textContent = 
                now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
        }

        function mostrarToast(message, type = 'info') {
            // Implementação simples de toast
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Auto-atualização a cada 5 minutos
        setInterval(function() {
            carregarDadosMapa();
        }, 300000);

        // Inicializar
        inicializarMapa();
    });
    </script>
{% endblock %}