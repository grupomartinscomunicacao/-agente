{% extends 'dashboard/base.html' %}

{% block title %}Dashboard - Sistema de Saúde{% endblock %}

{% block page_title %}Dashboard Principal{% endblock %}

{% block page_actions %}
    <div class="btn-group" role="group">
        <a href="{% url 'dashboard:coleta_dados' %}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Nova Coleta
        </a>
        <a href="{% url 'dashboard:gerar_relatorio' %}" class="btn btn-outline-primary">
            <i class="fas fa-chart-bar me-1"></i>Gerar Relatório
        </a>
    </div>
{% endblock %}

{% block content %}
    <!-- Estatísticas Principais -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex align-items-center">
                    <div class="icon bg-primary-custom me-3">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <h3 class="mb-0" id="total-cidadaos">{{ stats.total_cidadaos_cadastrados }}</h3>
                        <p class="text-muted mb-0">Cidadãos Cadastrados</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex align-items-center">
                    <div class="icon bg-success-custom me-3">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div>
                        <h3 class="mb-0" id="atendimentos-hoje">{{ stats.total_atendimentos_hoje }}</h3>
                        <p class="text-muted mb-0">Atendimentos Hoje</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex align-items-center">
                    <div class="icon bg-warning-custom me-3">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <h3 class="mb-0" id="anamneses-pendentes">{{ stats.total_anamneses_pendentes }}</h3>
                        <p class="text-muted mb-0">Anamneses Pendentes</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex align-items-center">
                    <div class="icon bg-danger-custom me-3">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div>
                        <h3 class="mb-0" id="casos-risco-alto">{{ stats.casos_risco_alto_hoje }}</h3>
                        <p class="text-muted mb-0">Casos Alto Risco Hoje</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gráficos -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>Atendimentos por Dia (Últimos 7 dias)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="chartAtendimentos"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Distribuição de Risco Hoje
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="chartRisco"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alertas Urgentes e Anamneses Pendentes -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                        Alertas Urgentes
                    </h5>
                    <a href="{% url 'dashboard:alertas' %}" class="btn btn-sm btn-outline-danger">
                        Ver Todos
                    </a>
                </div>
                <div class="card-body">
                    {% if alertas_urgentes %}
                        {% for alerta in alertas_urgentes %}
                            <div class="alert alert-danger alert-priority-alta d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ alerta.titulo }}</h6>
                                    <small class="text-muted">
                                        {{ alerta.anamnese.cidadao.nome }} - 
                                        {{ alerta.criado_em|date:"d/m/Y H:i" }}
                                    </small>
                                    <p class="mb-0 small">{{ alerta.descricao|truncatewords:15 }}</p>
                                </div>
                                <a href="{% url 'dashboard:anamnese_detail' alerta.anamnese.id %}" 
                                   class="btn btn-sm btn-outline-danger">
                                    Ver
                                </a>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center py-3">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Nenhum alerta urgente no momento
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-stethoscope text-warning me-2"></i>
                        Anamneses Pendentes
                    </h5>
                    <a href="{% url 'dashboard:anamneses_list' %}?status=pendente" class="btn btn-sm btn-outline-warning">
                        Ver Todas
                    </a>
                </div>
                <div class="card-body">
                    {% if anamneses_pendentes %}
                        {% for anamnese in anamneses_pendentes %}
                            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                                <div>
                                    <h6 class="mb-1">{{ anamnese.cidadao.nome }}</h6>
                                    <small class="text-muted">
                                        {{ anamnese.criado_em|date:"d/m/Y H:i" }}
                                        <span class="badge risk-{{ anamnese.triagem_risco }} ms-2">
                                            {{ anamnese.get_triagem_risco_display }}
                                        </span>
                                    </small>
                                </div>
                                <div>
                                    <a href="{% url 'dashboard:anamnese_detail' anamnese.id %}" 
                                       class="btn btn-sm btn-outline-primary">
                                        Revisar
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center py-3">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Todas as anamneses foram revisadas
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status de Atualização -->
    <div class="row mt-3">
        <div class="col-12">
            <small class="text-muted" id="ultima-atualizacao">
                Última atualização: {{ stats.ultima_atualizacao|date:"H:i:s" }}
            </small>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Dados dos gráficos
    const atendimentosData = {{ atendimentos_por_dia|safe }};
    const riscoData = {{ distribuicao_risco|safe }};
    
    // Gráfico de Atendimentos por Dia
    const ctxAtendimentos = document.getElementById('chartAtendimentos').getContext('2d');
    new Chart(ctxAtendimentos, {
        type: 'line',
        data: {
            labels: atendimentosData.map(item => item.data),
            datasets: [{
                label: 'Atendimentos',
                data: atendimentosData.map(item => item.count),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    
    // Gráfico de Distribuição de Risco
    const ctxRisco = document.getElementById('chartRisco').getContext('2d');
    const riscoColors = {
        'baixo': '#28a745',
        'medio': '#ffc107', 
        'alto': '#dc3545',
        'critico': '#6610f2'
    };
    
    new Chart(ctxRisco, {
        type: 'doughnut',
        data: {
            labels: riscoData.map(item => {
                const labels = {
                    'baixo': 'Baixo',
                    'medio': 'Médio',
                    'alto': 'Alto', 
                    'critico': 'Crítico'
                };
                return labels[item.triagem_risco] || item.triagem_risco;
            }),
            datasets: [{
                data: riscoData.map(item => item.count),
                backgroundColor: riscoData.map(item => riscoColors[item.triagem_risco] || '#6c757d'),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });
</script>
{% endblock %}