{% extends 'dashboard/base.html' %}

{% block title %}
{% if object %}Editar Cidadão{% else %}Novo Cidadão{% endif %} - Sistema de Saúde
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard:dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'dashboard:cidadaos_list' %}">Cidadãos</a></li>
                <li class="breadcrumb-item active">
                    {% if object %}Editar{% else %}Novo{% endif %}
                </li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-user-plus me-2"></i>
                {% if object %}Editar Cidadão{% else %}Cadastrar Novo Cidadão{% endif %}
            </h2>
            <a href="{% url 'dashboard:cidadaos_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Voltar
            </a>
        </div>

        <div class="card">
            <div class="card-body">
                <form method="post" id="cidadaoForm">
                    {% csrf_token %}
                    
                    <!-- Dados Pessoais -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary border-bottom pb-2">
                                <i class="fas fa-user me-2"></i>Dados Pessoais
                            </h5>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="id_nome" class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="id_nome" name="nome" 
                                   value="{{ form.nome.value|default:'' }}" required>
                            {% if form.nome.errors %}
                                <div class="text-danger">{{ form.nome.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="id_cpf" class="form-label">CPF *</label>
                            <input type="text" class="form-control" id="id_cpf" name="cpf" 
                                   value="{{ form.cpf.value|default:'' }}" 
                                   placeholder="000.000.000-00" required>
                            {% if form.cpf.errors %}
                                <div class="text-danger">{{ form.cpf.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="id_data_nascimento" class="form-label">Data de Nascimento *</label>
                            <input type="date" class="form-control" id="id_data_nascimento" name="data_nascimento" 
                                   value="{{ form.data_nascimento.value|date:'Y-m-d'|default:'' }}" required>
                            {% if form.data_nascimento.errors %}
                                <div class="text-danger">{{ form.data_nascimento.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="id_sexo" class="form-label">Sexo *</label>
                            <select class="form-select" id="id_sexo" name="sexo" required>
                                <option value="">Selecione...</option>
                                <option value="M" {% if form.sexo.value == 'M' %}selected{% endif %}>Masculino</option>
                                <option value="F" {% if form.sexo.value == 'F' %}selected{% endif %}>Feminino</option>
                                <option value="O" {% if form.sexo.value == 'O' %}selected{% endif %}>Outro</option>
                            </select>
                            {% if form.sexo.errors %}
                                <div class="text-danger">{{ form.sexo.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="id_estado_civil" class="form-label">Estado Civil</label>
                            <select class="form-select" id="id_estado_civil" name="estado_civil">
                                <option value="">Selecione...</option>
                                <option value="S" {% if form.estado_civil.value == 'S' %}selected{% endif %}>Solteiro(a)</option>
                                <option value="C" {% if form.estado_civil.value == 'C' %}selected{% endif %}>Casado(a)</option>
                                <option value="D" {% if form.estado_civil.value == 'D' %}selected{% endif %}>Divorciado(a)</option>
                                <option value="V" {% if form.estado_civil.value == 'V' %}selected{% endif %}>Viúvo(a)</option>
                                <option value="U" {% if form.estado_civil.value == 'U' %}selected{% endif %}>União Estável</option>
                            </select>
                            {% if form.estado_civil.errors %}
                                <div class="text-danger">{{ form.estado_civil.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="id_telefone" class="form-label">Telefone</label>
                            <input type="tel" class="form-control" id="id_telefone" name="telefone" 
                                   value="{{ form.telefone.value|default:'' }}" 
                                   placeholder="(11) 99999-9999">
                            {% if form.telefone.errors %}
                                <div class="text-danger">{{ form.telefone.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="id_profissao" class="form-label">Profissão</label>
                            <input type="text" class="form-control" id="id_profissao" name="profissao" 
                                   value="{{ form.profissao.value|default:'' }}" 
                                   placeholder="Ex: Enfermeiro, Professor">
                            {% if form.profissao.errors %}
                                <div class="text-danger">{{ form.profissao.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="id_email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="id_email" name="email" 
                                   value="{{ form.email.value|default:'' }}" 
                                   placeholder="cidadao@email.com">
                            {% if form.email.errors %}
                                <div class="text-danger">{{ form.email.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Endereço -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary border-bottom pb-2">
                                <i class="fas fa-map-marker-alt me-2"></i>Endereço
                            </h5>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="id_endereco" class="form-label">Endereço Completo</label>
                            <input type="text" class="form-control" id="id_endereco" name="endereco" 
                                   value="{{ form.endereco.value|default:'' }}" 
                                   placeholder="Rua, número, complemento">
                            {% if form.endereco.errors %}
                                <div class="text-danger">{{ form.endereco.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="id_cep" class="form-label">CEP</label>
                            <input type="text" class="form-control" id="id_cep" name="cep" 
                                   value="{{ form.cep.value|default:'' }}" 
                                   placeholder="00000-000">
                            {% if form.cep.errors %}
                                <div class="text-danger">{{ form.cep.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="id_cidade" class="form-label">Cidade *</label>
                            <input type="text" class="form-control" id="id_cidade" name="cidade" 
                                   value="{{ form.cidade.value|default:'' }}" required>
                            {% if form.cidade.errors %}
                                <div class="text-danger">{{ form.cidade.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="id_bairro" class="form-label">Bairro</label>
                            <input type="text" class="form-control" id="id_bairro" name="bairro" 
                                   value="{{ form.bairro.value|default:'' }}" 
                                   placeholder="Nome do bairro">
                            {% if form.bairro.errors %}
                                <div class="text-danger">{{ form.bairro.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="id_estado" class="form-label">Estado *</label>
                            <select class="form-select" id="id_estado" name="estado" required>
                                <option value="">Selecione...</option>
                                <option value="AC" {% if form.estado.value == 'AC' %}selected{% endif %}>Acre</option>
                                <option value="AL" {% if form.estado.value == 'AL' %}selected{% endif %}>Alagoas</option>
                                <option value="AP" {% if form.estado.value == 'AP' %}selected{% endif %}>Amapá</option>
                                <option value="AM" {% if form.estado.value == 'AM' %}selected{% endif %}>Amazonas</option>
                                <option value="BA" {% if form.estado.value == 'BA' %}selected{% endif %}>Bahia</option>
                                <option value="CE" {% if form.estado.value == 'CE' %}selected{% endif %}>Ceará</option>
                                <option value="DF" {% if form.estado.value == 'DF' %}selected{% endif %}>Distrito Federal</option>
                                <option value="ES" {% if form.estado.value == 'ES' %}selected{% endif %}>Espírito Santo</option>
                                <option value="GO" {% if form.estado.value == 'GO' %}selected{% endif %}>Goiás</option>
                                <option value="MA" {% if form.estado.value == 'MA' %}selected{% endif %}>Maranhão</option>
                                <option value="MT" {% if form.estado.value == 'MT' %}selected{% endif %}>Mato Grosso</option>
                                <option value="MS" {% if form.estado.value == 'MS' %}selected{% endif %}>Mato Grosso do Sul</option>
                                <option value="MG" {% if form.estado.value == 'MG' %}selected{% endif %}>Minas Gerais</option>
                                <option value="PA" {% if form.estado.value == 'PA' %}selected{% endif %}>Pará</option>
                                <option value="PB" {% if form.estado.value == 'PB' %}selected{% endif %}>Paraíba</option>
                                <option value="PR" {% if form.estado.value == 'PR' %}selected{% endif %}>Paraná</option>
                                <option value="PE" {% if form.estado.value == 'PE' %}selected{% endif %}>Pernambuco</option>
                                <option value="PI" {% if form.estado.value == 'PI' %}selected{% endif %}>Piauí</option>
                                <option value="RJ" {% if form.estado.value == 'RJ' %}selected{% endif %}>Rio de Janeiro</option>
                                <option value="RN" {% if form.estado.value == 'RN' %}selected{% endif %}>Rio Grande do Norte</option>
                                <option value="RS" {% if form.estado.value == 'RS' %}selected{% endif %}>Rio Grande do Sul</option>
                                <option value="RO" {% if form.estado.value == 'RO' %}selected{% endif %}>Rondônia</option>
                                <option value="RR" {% if form.estado.value == 'RR' %}selected{% endif %}>Roraima</option>
                                <option value="SC" {% if form.estado.value == 'SC' %}selected{% endif %}>Santa Catarina</option>
                                <option value="SP" {% if form.estado.value == 'SP' %}selected{% endif %}>São Paulo</option>
                                <option value="SE" {% if form.estado.value == 'SE' %}selected{% endif %}>Sergipe</option>
                                <option value="TO" {% if form.estado.value == 'TO' %}selected{% endif %}>Tocantins</option>
                            </select>
                            {% if form.estado.errors %}
                                <div class="text-danger">{{ form.estado.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Informações de Saúde -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-success border-bottom pb-2">
                                <i class="fas fa-heartbeat me-2"></i>Informações Básicas de Saúde
                            </h5>
                        </div>
                    </div>

                    <!-- Condições Crônicas -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="text-muted">Condições Crônicas</h6>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="id_possui_hipertensao" 
                                       name="possui_hipertensao" {% if form.possui_hipertensao.value %}checked{% endif %}>
                                <label class="form-check-label" for="id_possui_hipertensao">
                                    Hipertensão
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="id_possui_diabetes" 
                                       name="possui_diabetes" {% if form.possui_diabetes.value %}checked{% endif %}>
                                <label class="form-check-label" for="id_possui_diabetes">
                                    Diabetes
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="id_possui_doenca_cardiaca" 
                                       name="possui_doenca_cardiaca" {% if form.possui_doenca_cardiaca.value %}checked{% endif %}>
                                <label class="form-check-label" for="id_possui_doenca_cardiaca">
                                    Doença Cardíaca
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="id_possui_doenca_renal" 
                                       name="possui_doenca_renal" {% if form.possui_doenca_renal.value %}checked{% endif %}>
                                <label class="form-check-label" for="id_possui_doenca_renal">
                                    Doença Renal
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="id_possui_asma" 
                                       name="possui_asma" {% if form.possui_asma.value %}checked{% endif %}>
                                <label class="form-check-label" for="id_possui_asma">
                                    Asma
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="id_possui_depressao" 
                                       name="possui_depressao" {% if form.possui_depressao.value %}checked{% endif %}>
                                <label class="form-check-label" for="id_possui_depressao">
                                    Depressão/Ansiedade
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="id_possui_plano_saude" 
                                       name="possui_plano_saude" {% if form.possui_plano_saude.value %}checked{% endif %}>
                                <label class="form-check-label" for="id_possui_plano_saude">
                                    Possui Plano de Saúde
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="id_renda_familiar" class="form-label">Renda Familiar (R$)</label>
                            <input type="number" class="form-control" id="id_renda_familiar" name="renda_familiar" 
                                   value="{{ form.renda_familiar.value|default:'' }}" 
                                   placeholder="0.00" step="0.01">
                            {% if form.renda_familiar.errors %}
                                <div class="text-danger">{{ form.renda_familiar.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Informações Médicas Adicionais -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="id_medicamentos_continuo" class="form-label">Medicamentos de Uso Contínuo</label>
                            <textarea class="form-control" id="id_medicamentos_continuo" name="medicamentos_continuo" 
                                      rows="3" placeholder="Liste os medicamentos em uso contínuo">{{ form.medicamentos_continuo.value|default:'' }}</textarea>
                            {% if form.medicamentos_continuo.errors %}
                                <div class="text-danger">{{ form.medicamentos_continuo.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="id_alergias_conhecidas" class="form-label">Alergias Conhecidas</label>
                            <textarea class="form-control" id="id_alergias_conhecidas" name="alergias_conhecidas" 
                                      rows="3" placeholder="Liste alergias conhecidas">{{ form.alergias_conhecidas.value|default:'' }}</textarea>
                            {% if form.alergias_conhecidas.errors %}
                                <div class="text-danger">{{ form.alergias_conhecidas.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <label for="id_cirurgias_anteriores" class="form-label">Cirurgias Anteriores</label>
                            <textarea class="form-control" id="id_cirurgias_anteriores" name="cirurgias_anteriores" 
                                      rows="2" placeholder="Liste cirurgias realizadas anteriormente">{{ form.cirurgias_anteriores.value|default:'' }}</textarea>
                            {% if form.cirurgias_anteriores.errors %}
                                <div class="text-danger">{{ form.cirurgias_anteriores.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'dashboard:cidadaos_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            {% if object %}Atualizar{% else %}Cadastrar{% endif %} Cidadão
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Máscara para CPF
    $('#id_cpf').on('input', function() {
        let cpf = this.value.replace(/\D/g, '');
        cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
        cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
        cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        this.value = cpf;
    });

    // Máscara para telefone
    $('#id_telefone').on('input', function() {
        let phone = this.value.replace(/\D/g, '');
        phone = phone.replace(/(\d{2})(\d)/, '($1) $2');
        phone = phone.replace(/(\d{4,5})(\d{4})$/, '$1-$2');
        this.value = phone;
    });

    // Máscara para CEP
    $('#id_cep').on('input', function() {
        let cep = this.value.replace(/\D/g, '');
        cep = cep.replace(/(\d{5})(\d)/, '$1-$2');
        this.value = cep;
    });

    // Validação do formulário
    $('#cidadaoForm').on('submit', function(e) {
        let isValid = true;
        
        // Validar campos obrigatórios
        $(this).find('[required]').each(function() {
            if (!$(this).val()) {
                isValid = false;
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });

        if (!isValid) {
            e.preventDefault();
            alert('Por favor, preencha todos os campos obrigatórios.');
        }
    });
});
</script>
{% endblock %}